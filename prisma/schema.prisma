generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// === STRUCTURE ORGANISATIONNELLE ===

model Siege {
  id         Int      @id @default(autoincrement())
  nom        String   @default("Siège Principal")
  adresse    String
  ville      String?
  codePostal String?
  pays       String   @default("France")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  franchises Franchise[]
  centres    Centre[]
}

model Franchise {
  id         Int      @id @default(autoincrement())
  siegeId    Int
  nom        String
  adresse    String
  ville      String?
  codePostal String?
  telephone  String?
  email      String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  siege   Siege    @relation(fields: [siegeId], references: [id])
  centres Centre[]

  @@index([siegeId])
}

model Centre {
  id            Int      @id @default(autoincrement())
  franchiseId   Int?
  siegeId       Int?
  nom           String
  adresse       String
  ville         String
  codePostal    String
  telephone     String?
  email         String?
  capaciteStock Int?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  franchise Franchise?      @relation(fields: [franchiseId], references: [id])
  siege     Siege?          @relation(fields: [siegeId], references: [id])
  employes  Employe[]
  dossiers  DossierClient[]
  stocks    Stock[]

  @@index([franchiseId])
  @@index([siegeId])
}

// === RESSOURCES HUMAINES ===

enum Role {
  SUPER_ADMIN
  FRANCHISE_ADMIN
  CENTRE_MANAGER
  COMMERCIAL
  TECHNICIEN
  ASSISTANT
}

model Employe {
  id           Int       @id @default(autoincrement())
  centreId     Int
  nom          String
  prenom       String
  email        String    @unique
  telephone    String?
  password     String
  role         Role      @default(COMMERCIAL)
  rang         Int?
  isActive     Boolean   @default(true)
  dateEmbauche DateTime  @default(now())
  lastLogin    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  centre        Centre          @relation(fields: [centreId], references: [id])
  dossiersGeres DossierClient[] @relation("CommercialAffilie")
  activites     Activite[]

  @@index([centreId])
}

// === CLIENTS & VÉHICULES ===

enum EtatDossier {
  PROSPECT
  EN_COURS
  ATTENTE_PIECES
  TERMINE
  FACTURE
  ANNULE
}

model DossierClient {
  id           Int  @id @default(autoincrement())
  centreId     Int
  commercialId Int?

  nom       String
  prenom    String
  email     String?
  telephone String

  etat          EtatDossier @default(EN_COURS)
  dateEntree    DateTime    @default(now())
  nombreRappels Int         @default(0)

  cadeau      String? @db.Text
  brisDeGlace Boolean @default(false)
  franchise   Boolean @default(false)
  assurance   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  centre     Centre     @relation(fields: [centreId], references: [id])
  commercial Employe?   @relation("CommercialAffilie", fields: [commercialId], references: [id])
  vehicules  Vehicule[]
  documents  Document[]
  rappels    Rappel[]
  activites  Activite[]

  @@index([centreId])
  @@index([commercialId])
  @@index([etat])
}

model Vehicule {
  id              Int     @id @default(autoincrement())
  dossierId       Int
  marque          String
  modele          String
  immatriculation String  @unique
  annee           Int?
  couleur         String?

  dossier DossierClient @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@index([dossierId])
  @@index([immatriculation])
}

// === DOCUMENTS ===

enum TypeDocument {
  PHOTO_PROBLEME
  CARTE_GRISE
  CONTROLE_TECHNIQUE
  BON_LIVRAISON
  FACTURE
  DEVIS
  AUTRE
}

model Document {
  id         Int          @id @default(autoincrement())
  dossierId  Int
  type       TypeDocument
  nom        String
  urlFichier String
  taille     Int?
  uploadedAt DateTime     @default(now())

  dossier DossierClient @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@index([dossierId])
}

// === RAPPELS ===

enum StatutRappel {
  PLANIFIE
  EFFECTUE
  MANQUE
  ANNULE
}

model Rappel {
  id         Int          @id @default(autoincrement())
  dossierId  Int
  dateRappel DateTime
  statut     StatutRappel @default(PLANIFIE)
  notes      String?      @db.Text
  createdAt  DateTime     @default(now())

  dossier DossierClient @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@index([dossierId])
  @@index([dateRappel])
  @@index([statut])
}

// === ACTIVITÉS/HISTORIQUE ===

enum TypeActivite {
  APPEL
  EMAIL
  VISITE
  RAPPEL
  NOTE
  INTERVENTION
  LIVRAISON
}

model Activite {
  id          Int          @id @default(autoincrement())
  dossierId   Int?
  employeId   Int?
  type        TypeActivite
  sujet       String
  description String?      @db.Text
  date        DateTime     @default(now())

  dossier DossierClient? @relation(fields: [dossierId], references: [id], onDelete: SetNull)
  employe Employe?       @relation(fields: [employeId], references: [id], onDelete: SetNull)

  @@index([dossierId])
  @@index([employeId])
  @@index([date])
}

// === STOCK ===

model Stock {
  id          Int      @id @default(autoincrement())
  centreId    Int
  reference   String
  designation String
  quantite    Int      @default(0)
  seuil       Int      @default(5)
  prixAchat   Decimal? @db.Decimal(10, 2)
  prixVente   Decimal? @db.Decimal(10, 2)
  updatedAt   DateTime @updatedAt

  centre Centre @relation(fields: [centreId], references: [id])

  @@unique([centreId, reference])
  @@index([centreId])
}
